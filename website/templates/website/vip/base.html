{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="{% static 'website/img/apple-icon.png' %} ">
  <link rel="icon" type="image/png" href="{% static 'website/img/cafe_logo.png' %}">
  <title>
    {{page}}
  </title>
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <!-- Nucleo Icons -->
  <link href="{% static 'website/css/nucleo-icons.css' %}" rel="stylesheet" />
  <link href="{% static 'website/css/nucleo-svg.css' %}" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <!-- CSS Files -->
  <link id="pagestyle" href="{% static 'website/css/material-dashboard.css' %}?v=3.2.0" rel="stylesheet" />
  <script src="https://khalti.com/static/khalti-checkout.js"></script>

</head>
<body>
  {% include 'website/vip/navbar.html' %}
  <div id="notification-toast-container" 
     class="position-fixed top-0 end-0 p-3"
     style="z-index: 9999;">
     <!-- Toasts will be inserted here -->
</div>
  {% block content %}
    
  
  {% endblock %}




    

  <!--   Core JS Files   -->
  <script src="{% static 'website/js/core/bootstrap.min.js' %}"></script>
  <script src="{% static 'website/js/core/popper.min.js' %}"></script>
  <script src="{% static 'website/js/plugins/perfect-scrollbar.min.js' %}"></script>
  <script src="{% static 'website/js/plugins/smooth-scrollbar.min.js' %}"></script>
  <script src="{% static 'website/js/plugins/chartjs.min.js' %}"></script>
  
  <!-- Your chart scripts and other JS -->
  
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Material Dashboard -->
  <script src="{% static 'website/js/material-dashboard.min.js' %}?v=3.2.0"></script>
  <!-- JavaScript for Today's Special -->
  <script src="{% static 'website/js/cartVipScript.js' %}"></script>


  <style>
    body{
      background-color: #e6e5e5;
    }
  </style>
    <!-- <script>
    const orderId = "{{ order.id }}";
    const statusUrl = "{% url 'vip_order_status' 0 %}".replace('0', orderId);

    function fetchOrderStatus() {
        fetch(statusUrl)
            .then(response => response.json())
            .then(data => {
                console.log("Fetched order status:", data); 
                const badge = document.querySelector('.badge');
                if (badge) {
                    badge.textContent = data.status_display;
                }
            })
            .catch(err => console.error("Status fetch error:", err));
    }

    setInterval(fetchOrderStatus, 5000);
</script> -->
<!-- <script>
    setTimeout(function () {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function (alert) {
            // Use Bootstrap's built-in dismiss method
            const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
            bsAlert.close();
        });
    }, 5000); // 5000ms = 5 seconds
</script> -->
<script>
// Store the last update time to prevent duplicate processing
let lastNotificationUpdate = null;

function fetchNotifications() {
    fetch("{% url 'vip_fetch_unread_notifications' %}")
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            // Update badge count
            const badge = document.getElementById('notification-badge');
            if (badge) {
                badge.textContent = data.unread_count;
                badge.classList.toggle('d-none', data.unread_count === 0);
            }
            
            // Only process new notifications
            if (data.notifications.length > 0 && 
                (!lastNotificationUpdate || data.last_updated > lastNotificationUpdate)) {
                
                lastNotificationUpdate = data.last_updated;
                
                // Process new notifications
                data.notifications.forEach(notification => {
                    showNotificationToast(notification);
                });
            }
        })
        .catch(error => console.error("Notification error:", error));
}

// Function to display notification toasts
function showNotificationToast(notification) {
    // Example using Bootstrap toasts
    const toastContainer = document.getElementById('notification-toast-container');
    if (!toastContainer) return;
    
   const toastEl = document.createElement('div');
    toastEl.className = 'toast show bg-dark text-white'; // Changed to dark/black
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    toastEl.innerHTML = `
        <div class="toast-header bg-black text-black"> <!-- Changed header to black -->
            <strong class="me-auto">${notification.type.replace('_', ' ')}</strong>
            <small>Just now</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            ${notification.message}
        </div>
    `;
    
    toastContainer.appendChild(toastEl);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toastEl.classList.remove('show');
        setTimeout(() => toastEl.remove(), 300);
    }, 5000);
}

function getNotificationClass(type) {
    const typeClasses = {
        'order_Status': 'bg-info text-white',
        'payment': 'bg-success text-white',
        'error': 'bg-danger text-white'
    };
    return typeClasses[type] || 'bg-light';
}

// Initialize interval polling
document.addEventListener('DOMContentLoaded', () => {
    fetchNotifications(); // Initial load
    const intervalId = setInterval(fetchNotifications, 5000); // Poll every 5 seconds
    
    // Clean up when leaving page
    window.addEventListener('beforeunload', () => {
        clearInterval(intervalId);
    });
});
</script>
{% block extra_scripts %}
{% endblock %}


</body>
</html>